<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur de Dispatch avec Gestion des Chauffeurs</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 95%;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: #34495e;
        }
        input, select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .add-row-btn {
            margin-top: 10px;
        }
        .reset-btn {
            background-color: #e74c3c;
            margin-left: 10px;
        }
        .reset-btn:hover {
            background-color: #c0392b;
        }
        .view-dispatch-btn {
            background-color: #2196F3;
        }
        .view-dispatch-btn:hover {
            background-color: #0b7dda;
        }
        .delete-btn {
            background-color: #f44336;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        .tabs {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 4px 4px 0 0;
        }
        .tabs button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
            color: #333;
        }
        .tabs button:hover {
            background-color: #ddd;
        }
        .tabs button.active {
            background-color: #3498db;
            color: white;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        .show {
            display: block;
        }
        .results {
            margin-top: 30px;
            padding: 15px;
            background-color: #eaf2f8;
            border-radius: 4px;
        }
        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #d5d8dc;
        }
        .result-label {
            font-weight: bold;
            color: #2c3e50;
        }
        .result-value {
            font-weight: bold;
            color: #3498db;
        }
        .back-btn {
            background-color: #607d8b;
            margin-bottom: 15px;
        }
        .back-btn:hover {
            background-color: #455a64;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        .driver-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .driver-header {
            font-weight: bold;
            font-size: 18px;
            color: #3498db;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .driver-arrival-time {
            color: #e74c3c;
            font-weight: bold;
            font-size: 16px;
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .driver-schedule {
            margin-left: 15px;
            margin-top: 10px;
        }
        .timeline {
            position: relative;
            padding: 20px 0;
            margin-top: 20px;
        }
        .timeline-header {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .timeline-hour {
            flex: 1;
            text-align: center;
            font-weight: bold;
            padding: 5px;
            border-right: 1px solid #ddd;
        }
        .timeline-hour:last-child {
            border-right: none;
        }
        .timeline-row {
            position: relative;
            height: 30px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        .timeline-label {
            width: 120px;
            font-weight: bold;
            padding-right: 10px;
            text-align: right;
        }
        .timeline-content {
            flex: 1;
            position: relative;
            height: 100%;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .timeline-bar {
            position: absolute;
            height: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            top: 5px;
        }
        .loading-bar {
            background-color: #3498db;
        }
        .travel-bar {
            background-color: #2ecc71;
        }
        .unloading-bar {
            background-color: #e74c3c;
        }
        .return-bar {
            background-color: #f39c12;
        }
        .arrival-marker {
            position: absolute;
            width: 2px;
            height: 20px;
            background-color: #e74c3c;
            top: 5px;
        }
        .arrival-label {
            position: absolute;
            color: #e74c3c;
            font-size: 10px;
            font-weight: bold;
            transform: translateX(-50%);
            white-space: nowrap;
        }
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .summary-table th, .summary-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .summary-table th {
            background-color: #f2f2f2;
        }
        .no-jobs {
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        /* Pour impression */
        @media print {
            .no-print {
                display: none;
            }
            body {
                background-color: white;
            }
            .container {
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
        }
        /* Loading spinner */
        .loading-spinner-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Pagination pour les chantiers */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
        }
        .status-message {
            color: #2ecc71;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        .error-message {
            color: #e74c3c;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading-spinner-container" id="loadingSpinner">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <h1>Calculateur de Dispatch avec Gestion des Chauffeurs</h1>
        
        <div class="tabs">
            <button class="tablink active" onclick="openTab(event, 'dailyJobs')">Chantiers du Jour</button>
            <button class="tablink" onclick="openTab(event, 'jobDispatch')">Vue du Dispatch</button>
            <button class="tablink" onclick="openTab(event, 'driversSchedule')">Horaire des Chauffeurs</button>
        </div>

        <div id="statusMessage" class="status-message"></div>
        <div id="errorMessage" class="error-message"></div>
        
        <!-- Onglet Chantiers du Jour -->
        <div id="dailyJobs" class="tabcontent show">
            <h2>Liste des Chantiers</h2>
            
            <div class="no-print" style="margin-bottom: 15px; text-align: right;">
                <button class="reset-btn" onclick="resetAllJobs()">Effacer tous les chantiers</button>
            </div>
            
            <table id="jobsTable">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Entreprise</th>
                        <th>Heure</th>
                        <th>Volume (m³)</th>
                        <th>Temps de Trajet (min)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Les lignes seront ajoutées ici dynamiquement -->
                </tbody>
            </table>
            
            <!-- Pagination pour les chantiers -->
            <div class="pagination" id="jobsPagination">
                <!-- Les boutons de pagination seront ajoutés ici dynamiquement -->
            </div>
            
            <button class="add-row-btn" onclick="addRow()">Ajouter un Chantier</button>
            
            <div style="margin-top: 20px;">
                <h3>Résumé du Jour</h3>
                <div id="dailySummary">
                    <!-- Le résumé sera affiché ici -->
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button id="syncAllJobsBtn" onclick="syncAllJobs()" style="background-color: #27ae60;">Calculer le Dispatch de Tous les Chantiers</button>
                    <button id="generateScheduleBtn" onclick="generateDriversSchedule()">Générer l'Horaire des Chauffeurs</button>
                </div>
            </div>
        </div>
        
        <!-- Onglet Vue du Dispatch -->
        <div id="jobDispatch" class="tabcontent">
            <button class="back-btn no-print" onclick="backToJobs()">Retour aux Chantiers</button>
            <button class="no-print" onclick="window.print()">Imprimer</button>
            
            <h2>Calculateur de Dispatch - <span id="jobName"></span></h2>
            
            <div id="dispatchCalculator">
                <div class="form-group">
                    <label for="arrivalTime">Heure d'arrivée prévue sur le chantier</label>
                    <input type="time" id="arrivalTime" value="07:00">
                </div>
                
                <div class="form-group">
                    <label for="cementQuantity">Quantité de ciment (m³)</label>
                    <input type="number" id="cementQuantity" value="0" min="0" step="0.1">
                </div>
                
                <div class="form-group">
                    <label for="travelTime">Temps estimé pour un trajet (minutes)</label>
                    <input type="number" id="travelTime" value="0" min="0">
                </div>
                
                <div class="form-group">
                    <label for="truckCapacity">Capacité d'un camion (m³)</label>
                    <input type="number" id="truckCapacity" value="8" min="0" step="0.1">
                </div>
                
                <div class="form-group">
                    <label for="loadingTime">Temps de chargement (minutes)</label>
                    <input type="number" id="loadingTime" value="15" min="0">
                </div>
                
                <div class="form-group">
                    <label for="unloadingTime">Temps de déchargement et lavage (minutes par camion)</label>
                    <input type="number" id="unloadingTime" value="30" min="0">
                </div>
                
                <div class="form-group">
                    <label for="truckInterval">Intervalle entre les départs des camions (minutes)</label>
                    <input type="number" id="truckInterval" value="15" min="0">
                </div>
                
                <button id="calculate">Calculer</button>
                
                <div class="results" id="results">
                    <div class="result-row">
                        <span class="result-label">Nombre de camions nécessaires:</span>
                        <span class="result-value" id="truckCount">0</span>
                    </div>
                    
                    <div class="result-row">
                        <span class="result-label">Temps pour un aller-retour complet (par camion):</span>
                        <span class="result-value" id="roundTripTime">0:00</span>
                    </div>
                    
                    <div class="result-row">
                        <span class="result-label">Heure de chargement du premier camion:</span>
                        <span class="result-value" id="firstLoadingTime">0:00</span>
                    </div>
                    
                    <div class="result-row">
                        <span class="result-label">Durée totale de l'opération:</span>
                        <span class="result-value" id="totalOperationTime">0:00</span>
                    </div>
                    
                    <div class="result-row">
                        <span class="result-label">Heure estimée de fin des travaux:</span>
                        <span class="result-value" id="estimatedEndTime">00:00</span>
                    </div>
                    
                    <h3>Détail des camions</h3>
                    <div id="truckDetails"></div>
                </div>
            </div>
        </div>
        
        <!-- Onglet Horaire des Chauffeurs -->
        <div id="driversSchedule" class="tabcontent">
            <button class="back-btn no-print" onclick="backToJobs()">Retour aux Chantiers</button>
            <button class="no-print" onclick="window.print()">Imprimer</button>
            
            <h2>Horaire des Chauffeurs</h2>
            
            <div id="driversSummary" style="margin-bottom: 20px;">
                <!-- Le résumé des heures d'arrivée des chauffeurs sera affiché ici -->
            </div>
            
            <div id="driversContainer">
                <!-- Les horaires des chauffeurs seront affichés ici -->
            </div>
            
            <h3>Chronologie des Camions</h3>
            <div id="timelineContainer">
                <!-- La chronologie sera affichée ici -->
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let jobs = [];
        let driverAssignments = [];  // Contient les assignations des chauffeurs
        let currentJobPage = 1;
        const jobsPerPage = 10; // Nombre de chantiers par page
        
        // Liste des chauffeurs par ordre d'ancienneté
        const drivers = [
            "Serge",
            "Marengère",
            "Gagnon",
            "Denis",
            "Gab",
            "Pat",
            "Monic",
            "Félix",
            "Robert"
        ];
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Charger les chantiers existants
            loadJobs();
            
            // Ajouter une ligne vide si aucun chantier
            if (jobs.length === 0) {
                addRow();
            } else {
                // Mettre à jour la pagination
                updateJobsPagination();
                // Afficher la première page
                displayJobsPage(1);
            }
            
            // Initialiser le calcul de dispatch
            document.getElementById('calculate').addEventListener('click', function() {
                calculateDispatch();
            });
        });
        
        // Afficher/masquer le spinner de chargement
        function showLoading(show = true) {
            document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
        }
        
        // Afficher un message de statut
        function showStatusMessage(message, duration = 3000) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.style.display = 'none';
            }, duration);
        }
        
        // Afficher un message d'erreur
        function showErrorMessage(message, duration = 5000) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            setTimeout(() => {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }, duration);
        }
        
        // Fonction pour ouvrir un onglet
        function openTab(evt, tabName) {
            let tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            let tablinks = document.getElementsByClassName("tablink");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        // Fonction pour retourner à la liste des chantiers
        function backToJobs() {
            document.querySelector('.tablink[onclick*="dailyJobs"]').click();
        }
        
        // Fonction pour ajouter une ligne au tableau
        function addRow() {
            const tbody = document.querySelector('#jobsTable tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="client-name" placeholder="Nom du client"></td>
                <td><input type="text" class="company-name" placeholder="Nom de l'entreprise"></td>
                <td><input type="time" class="work-time"></td>
                <td><input type="number" class="meter-needed" min="0" step="0.5" placeholder="m³"></td>
                <td><input type="number" class="travel-time" min="0" placeholder="minutes"></td>
                <td>
                    <button class="view-dispatch-btn" onclick="viewDispatch(this)">Voir Dispatch</button>
                    <button class="delete-btn" onclick="deleteRow(this)">X</button>
                </td>
            `;
            tbody.appendChild(newRow);
            
            // Si c'est un nouveau chantier (pas un chargement initial),
            // on met à jour la pagination et on va à la dernière page
            if (jobs.length > 0) {
                updateJobsPagination();
                displayJobsPage(Math.ceil(jobs.length / jobsPerPage));
            }
        }
        
        // Fonction pour supprimer une ligne
        function deleteRow(button) {
            const row = button.closest('tr');
            
            // Si la ligne a un ID, supprimer de la liste des jobs
            if (row.hasAttribute('data-job-id')) {
                const jobId = row.getAttribute('data-job-id');
                jobs = jobs.filter(job => job.id !== jobId);
                saveJobs();
            }
            
            row.remove();
            updateDailySummary();
            
            // Mettre à jour la pagination
            updateJobsPagination();
            
            // Si la page actuelle n'a plus de chantiers et ce n'est pas la première page,
            // aller à la page précédente
            const tbody = document.querySelector('#jobsTable tbody');
            if (tbody.children.length === 0 && currentJobPage > 1) {
                displayJobsPage(currentJobPage - 1);
            }
        }
        
        // Fonction pour effacer tous les chantiers
        function resetAllJobs() {
            if (confirm("Êtes-vous sûr de vouloir effacer tous les chantiers?")) {
                jobs = [];
                driverAssignments = [];
                saveJobs();
                
                // Vider le tableau
                const tbody = document.querySelector('#jobsTable tbody');
                tbody.innerHTML = '';
                
                // Ajouter une ligne vide
                addRow();
                
                // Mettre à jour le résumé
                updateDailySummary();
                
                // Réinitialiser la pagination
                currentJobPage = 1;
                updateJobsPagination();
            }
        }
        
        // Fonction pour mettre à jour la pagination des chantiers
        function updateJobsPagination() {
            const paginationContainer = document.getElementById('jobsPagination');
            paginationContainer.innerHTML = '';
            
            // Si moins de chantiers que la limite par page, cacher la pagination
            if (jobs.length <= jobsPerPage) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            
            // Calculer le nombre de pages
            const pageCount = Math.ceil(jobs.length / jobsPerPage);
            
            // Bouton précédent
            const prevButton = document.createElement('button');
            prevButton.textContent = '«';
            prevButton.onclick = () => {
                if (currentJobPage > 1) {
                    displayJobsPage(currentJobPage - 1);
                }
            };
            prevButton.disabled = currentJobPage === 1;
            paginationContainer.appendChild(prevButton);
            
            // Limiter le nombre de boutons de page affichés
            const maxVisibleButtons = 5;
            let startPage = Math.max(1, currentJobPage - Math.floor(maxVisibleButtons / 2));
            let endPage = Math.min(pageCount, startPage + maxVisibleButtons - 1);
            
            // Ajuster si on est près de la fin
            if (endPage - startPage + 1 < maxVisibleButtons) {
                startPage = Math.max(1, endPage - maxVisibleButtons + 1);
            }
            
            // Boutons de page
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.onclick = () => displayJobsPage(i);
                
                if (i === currentJobPage) {
                    pageButton.style.backgroundColor = '#2c3e50';
                    pageButton.style.color = 'white';
                }
                
                paginationContainer.appendChild(pageButton);
            }
            
            // Bouton suivant
            const nextButton = document.createElement('button');
            nextButton.textContent = '»';
            nextButton.onclick = () => {
                if (currentJobPage < pageCount) {
                    displayJobsPage(currentJobPage + 1);
                }
            };
            nextButton.disabled = currentJobPage === pageCount;
            paginationContainer.appendChild(nextButton);
        }
        
        // Fonction pour afficher une page de chantiers
        function displayJobsPage(pageNumber) {
            currentJobPage = pageNumber;
            
            const tbody = document.querySelector('#jobsTable tbody');
            tbody.innerHTML = '';
            
            // Calculer les indices de début et de fin pour cette page
            const startIndex = (pageNumber - 1) * jobsPerPage;
            const endIndex = Math.min(startIndex + jobsPerPage, jobs.length);
            
            // Afficher les chantiers de cette page
            for (let i = startIndex; i < endIndex; i++) {
                const job = jobs[i];
                const newRow = document.createElement('tr');
                newRow.setAttribute('data-job-id', job.id);
                
                newRow.innerHTML = `
                    <td><input type="text" class="client-name" value="${job.name || ''}" placeholder="Nom du client"></td>
                    <td><input type="text" class="company-name" value="${job.company || ''}" placeholder="Nom de l'entreprise"></td>
                    <td><input type="time" class="work-time" value="${job.workTime || ''}"></td>
                    <td><input type="number" class="meter-needed" min="0" step="0.5" value="${job.meterNeeded || ''}" placeholder="m³"></td>
                    <td><input type="number" class="travel-time" min="0" value="${job.travelTime || ''}" placeholder="minutes"></td>
                    <td>
                        <button class="view-dispatch-btn" onclick="viewDispatch(this)">Voir Dispatch</button>
                        <button class="delete-btn" onclick="deleteRow(this)">X</button>
                    </td>
                `;
                
                tbody.appendChild(newRow);
            }
            
            // Mettre à jour la pagination
            updateJobsPagination();
        }
        
        // Fonction pour voir le dispatch d'un chantier
        function viewDispatch(button) {
            const row = button.closest('tr');
            
            // Récupérer les données du formulaire
            const jobData = {
                name: row.querySelector('.client-name').value,
                company: row.querySelector('.company-name').value,
                workTime: row.querySelector('.work-time').value,
                meterNeeded: parseFloat(row.querySelector('.meter-needed').value) || 0,
                travelTime: parseInt(row.querySelector('.travel-time').value) || 0
            };
            
            // Validation des données
            if (!jobData.name || !jobData.workTime || !jobData.meterNeeded || !jobData.travelTime) {
                showErrorMessage("Veuillez remplir tous les champs obligatoires (client, heure, volume et temps de trajet).");
                return;
            }
            
            // Générer un ID pour ce chantier
            if (!row.hasAttribute('data-job-id')) {
                const jobId = Date.now().toString();
                row.setAttribute('data-job-id', jobId);
                jobData.id = jobId;
            } else {
                jobData.id = row.getAttribute('data-job-id');
            }
            
            // Enregistrer ce chantier dans la liste
            saveJob(jobData);
            
            // Mettre à jour les champs dans la vue dispatch
            document.getElementById('arrivalTime').value = jobData.workTime;
            document.getElementById('cementQuantity').value = jobData.meterNeeded;
            document.getElementById('travelTime').value = jobData.travelTime;
            
            // Mettre à jour le nom du chantier
            document.getElementById('jobName').textContent = `${jobData.name} (${jobData.company})`;
            
            // Effectuer le calcul initial
            calculateDispatch();
            
            // Basculer vers l'onglet du dispatch
            document.querySelector('.tablink[onclick*="jobDispatch"]').click();
        }
        
        // Fonction pour synchroniser tous les chantiers (calculer le dispatch pour chaque chantier)
        function syncAllJobs() {
            showLoading(true);
            
            // Message initial
            showStatusMessage("Démarrage du calcul pour tous les chantiers...");
            
            // Vérifier qu'il y a des chantiers
            if (jobs.length === 0) {
                showErrorMessage("Aucun chantier n'a été ajouté.");
                showLoading(false);
                return;
            }
            
            // Filtrer les chantiers valides (qui ont toutes les données nécessaires)
            const validJobs = jobs.filter(job => 
                job && job.name && job.workTime && 
                job.meterNeeded && job.travelTime
            );
            
            if (validJobs.length === 0) {
                showErrorMessage("Aucun chantier valide trouvé. Assurez-vous que tous les champs sont remplis.");
                showLoading(false);
                return;
            }
            
            // Message pour indiquer le nombre de chantiers à traiter
            showStatusMessage(`Calcul en cours pour ${validJobs.length} chantiers...`);
            
            // Traiter les chantiers par lots pour ne pas bloquer l'interface
            const batchSize = 5; // Traiter 5 chantiers à la fois
            let processedCount = 0;
            
            function processBatch(startIndex) {
                // Calculer l'indice de fin pour cette batch
                const endIndex = Math.min(startIndex + batchSize, validJobs.length);
                
                // Traiter chaque chantier de cette batch
                for (let i = startIndex; i < endIndex; i++) {
                    try {
                        const job = validJobs[i];
                        
                        // Mettre à jour le message de statut
                        showStatusMessage(`Calcul en cours pour le chantier ${i+1}/${validJobs.length}: ${job.name}`);
                        
                        // Calculer le dispatch pour ce chantier
                        calculateJobDispatch(job);
                        
                        // Incrémenter le compteur de chantiers traités
                        processedCount++;
                    } catch (error) {
                        console.error(`Erreur lors du calcul du dispatch pour le chantier ${i}:`, error);
                    }
                }
                
                // Si tous les chantiers ont été traités, terminer le processus
                if (endIndex >= validJobs.length) {
                    // Sauvegarder tous les chantiers
                    saveJobs();
                    
                    // Mettre à jour le résumé
                    updateDailySummary();
                    
                    // Afficher un message de succès
                    showStatusMessage(`Calcul terminé pour ${processedCount} chantiers sur ${validJobs.length}.`);
                    
                    // Masquer le spinner de chargement
                    showLoading(false);
                } else {
                    // Il reste des chantiers à traiter, continuer avec la prochaine batch
                    setTimeout(() => {
                        processBatch(endIndex);
                    }, 50); // Petit délai pour permettre à l'interface de se mettre à jour
                }
            }
            
            // Démarrer le traitement avec la première batch
            setTimeout(() => {
                processBatch(0);
            }, 100);
        }
        
        // Fonction pour calculer le dispatch pour un chantier spécifique
        function calculateJobDispatch(job) {
            // Paramètres par défaut
            const arrivalTime = job.workTime;
            const cementQuantity = parseFloat(job.meterNeeded);
            const travelTime = parseInt(job.travelTime);
            const truckCapacity = 8; // Valeur par défaut
            const loadingTime = 15; // Valeur par défaut
            const unloadingTime = 30; // Valeur par défaut
            const truckInterval = 15; // Valeur par défaut
            
            // Calculer le nombre de camions nécessaires
            const truckCount = Math.ceil(cementQuantity / truckCapacity);
            
            // Calculer le temps d'aller-retour
            const roundTripMinutes = travelTime * 2 + unloadingTime;
            
            // Calculer l'heure du premier chargement
            const arrivalTimeParts = arrivalTime.split(':').map(part => parseInt(part));
            let loadingTimeMinutes = arrivalTimeParts[0] * 60 + arrivalTimeParts[1] - travelTime - loadingTime - 5;
            if (loadingTimeMinutes < 0) loadingTimeMinutes += 24 * 60; // Traiter le passage à la journée précédente
            
            // Créer un tableau de dispatch pour ce chantier
            const truckDetails = [];
            for (let i = 0; i < truckCount; i++) {
                const truckLoadingMinutes = loadingTimeMinutes + (i * truckInterval);
                const truckArrivalMinutes = truckLoadingMinutes + loadingTime + travelTime;
                const truckDepartureMinutes = truckArrivalMinutes + unloadingTime;
                const truckReturnMinutes = truckDepartureMinutes + travelTime;
                
                // Calculer l'heure d'arrivée du chauffeur (15 minutes avant le chargement)
                const driverArrivalMinutes = truckLoadingMinutes - 15;
                
                const truckVolume = i === truckCount - 1 
                    ? cementQuantity - (truckCount - 1) * truckCapacity 
                    : truckCapacity;
                
                truckDetails.push({
                    truckNumber: i + 1,
                    jobId: job.id,
                    jobName: job.name,
                    company: job.company,
                    volume: truckVolume,
                    driverArrivalMinutes: driverArrivalMinutes,
                    loadingTimeMinutes: truckLoadingMinutes,
                    arrivalTimeMinutes: truckArrivalMinutes,
                    departureTimeMinutes: truckDepartureMinutes,
                    returnTimeMinutes: truckReturnMinutes,
                    driverArrivalTime: minutesToTimeString(driverArrivalMinutes),
                    loadingTime: minutesToTimeString(truckLoadingMinutes),
                    arrivalTime: minutesToTimeString(truckArrivalMinutes),
                    departureTime: minutesToTimeString(truckDepartureMinutes),
                    returnTime: minutesToTimeString(truckReturnMinutes),
                    travelTime: travelTime,
                    loadingDuration: loadingTime,
                    unloadingDuration: unloadingTime
                });
            }
            
            // Mettre à jour le chantier avec les données calculées
            job.dispatch = truckDetails;
            job.calculatedData = {
                truckCapacity,
                loadingTime,
                unloadingTime,
                truckInterval,
                totalTrucks: truckCount
            };
            
            return job;
        }
        
        // Fonction pour calculer le dispatch depuis l'interface utilisateur
        function calculateDispatch() {
            // Get input values
            const arrivalTime = document.getElementById('arrivalTime').value;
            const cementQuantity = parseFloat(document.getElementById('cementQuantity').value);
            const travelTime = parseInt(document.getElementById('travelTime').value);
            const truckCapacity = parseFloat(document.getElementById('truckCapacity').value);
            const loadingTime = parseInt(document.getElementById('loadingTime').value);
            const unloadingTime = parseInt(document.getElementById('unloadingTime').value);
            const truckInterval = parseInt(document.getElementById('truckInterval').value);
            
            // Calculate number of trucks needed
            const truckCount = Math.ceil(cementQuantity / truckCapacity);
            
            // Calculate round trip time (travel time * 2 + unloading time)
            const roundTripMinutes = travelTime * 2 + unloadingTime;
            const roundTripHours = Math.floor(roundTripMinutes / 60);
            const roundTripMins = roundTripMinutes % 60;
            const roundTripTimeFormatted = `${roundTripHours}:${roundTripMins.toString().padStart(2, '0')}`;
            
            // Calculate first loading time (camions programmés 5 minutes avant l'heure prévue)
            const arrivalTimeParts = arrivalTime.split(':').map(part => parseInt(part));
            // Calculer pour que les camions arrivent 5 minutes AVANT l'heure prévue
            let loadingTimeMinutes = arrivalTimeParts[0] * 60 + arrivalTimeParts[1] - travelTime - loadingTime - 5;
            if (loadingTimeMinutes < 0) loadingTimeMinutes += 24 * 60; // Handle wraparound to previous day
            const loadingTimeHours = Math.floor(loadingTimeMinutes / 60);
            const loadingTimeMins = loadingTimeMinutes % 60;
            const firstLoadingTimeFormatted = `${loadingTimeHours}:${loadingTimeMins.toString().padStart(2, '0')}`;
            
            // Calculate total operation time
            const totalOperationMinutes = ((truckCount - 1) * truckInterval) + roundTripMinutes;
            const totalOperationHours = Math.floor(totalOperationMinutes / 60);
            const totalOperationMins = totalOperationMinutes % 60;
            const totalOperationTimeFormatted = `${totalOperationHours}:${totalOperationMins.toString().padStart(2, '0')}`;
            
            // Calculate estimated end time
            const endTimeMinutes = arrivalTimeParts[0] * 60 + arrivalTimeParts[1] + totalOperationMinutes;
            const endTimeHours = Math.floor(endTimeMinutes / 60) % 24;
            const endTimeMins = endTimeMinutes % 60;
            const estimatedEndTimeFormatted = `${endTimeHours}:${endTimeMins.toString().padStart(2, '0')}`;
            
            // Update results
            document.getElementById('truckCount').textContent = truckCount;
            document.getElementById('roundTripTime').textContent = roundTripTimeFormatted;
            document.getElementById('firstLoadingTime').textContent = firstLoadingTimeFormatted;
            document.getElementById('totalOperationTime').textContent = totalOperationTimeFormatted;
            document.getElementById('estimatedEndTime').textContent = estimatedEndTimeFormatted;
            
            // Generate truck details
            const truckDetailsElement = document.getElementById('truckDetails');
            truckDetailsElement.innerHTML = '';
            
            const truckDetailsTable = document.createElement('table');
            truckDetailsTable.style.width = '100%';
            truckDetailsTable.style.borderCollapse = 'collapse';
            truckDetailsTable.style.marginTop = '10px';
            
            // Create header row
            const headerRow = document.createElement('tr');
            const headers = ['Camion #', 'Chargement', 'Arrivée', 'Départ', 'Retour'];
            
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                th.style.padding = '8px';
                th.style.borderBottom = '2px solid #ddd';
                th.style.textAlign = 'left';
                headerRow.appendChild(th);
            });
            
            truckDetailsTable.appendChild(headerRow);
            
            // Create truck detail rows
            for (let i = 0; i < truckCount; i++) {
                const truckRow = document.createElement('tr');
                
                // Truck number
                const truckNumberCell = document.createElement('td');
                truckNumberCell.textContent = i + 1;
                truckNumberCell.style.padding = '8px';
                truckNumberCell.style.borderBottom = '1px solid #ddd';
                truckRow.appendChild(truckNumberCell);
                
                // Loading time (first loading time + i * interval)
                const truckLoadingMinutes = loadingTimeMinutes + (i * truckInterval);
                const truckLoadingHours = Math.floor(truckLoadingMinutes / 60) % 24;
                const truckLoadingMins = truckLoadingMinutes % 60;
                const truckLoadingFormatted = `${truckLoadingHours}:${truckLoadingMins.toString().padStart(2, '0')}`;
                
                const loadingCell = document.createElement('td');
                loadingCell.textContent = truckLoadingFormatted;
                loadingCell.style.padding = '8px';
                loadingCell.style.borderBottom = '1px solid #ddd';
                truckRow.appendChild(loadingCell);
                
                // Arrival time (loading time + loading duration + travel time)
                const truckArrivalMinutes = truckLoadingMinutes + loadingTime + travelTime;
                const truckArrivalHours = Math.floor(truckArrivalMinutes / 60) % 24;
                const truckArrivalMins = truckArrivalMinutes % 60;
                const truckArrivalFormatted = `${truckArrivalHours}:${truckArrivalMins.toString().padStart(2, '0')}`;
                
                const arrivalCell = document.createElement('td');
                arrivalCell.textContent = truckArrivalFormatted;
                arrivalCell.style.padding = '8px';
                arrivalCell.style.borderBottom = '1px solid #ddd';
                truckRow.appendChild(arrivalCell);
                
                // Departure time (arrival time + unloading time)
                const truckDepartureMinutes = truckArrivalMinutes + unloadingTime;
                const truckDepartureHours = Math.floor(truckDepartureMinutes / 60) % 24;
                const truckDepartureMins = truckDepartureMinutes % 60;
                const truckDepartureFormatted = `${truckDepartureHours}:${truckDepartureMins.toString().padStart(2, '0')}`;
                
                const departureCell = document.createElement('td');
                departureCell.textContent = truckDepartureFormatted;
                departureCell.style.padding = '8px';
                departureCell.style.borderBottom = '1px solid #ddd';
                truckRow.appendChild(departureCell);
                
                // Return time (departure time + travel time)
                const truckReturnMinutes = truckDepartureMinutes + travelTime;
                const truckReturnHours = Math.floor(truckReturnMinutes / 60) % 24;
                const truckReturnMins = truckReturnMinutes % 60;
                const truckReturnFormatted = `${truckReturnHours}:${truckReturnMins.toString().padStart(2, '0')}`;
                
                const returnCell = document.createElement('td');
                returnCell.textContent = truckReturnFormatted;
                returnCell.style.padding = '8px';
                returnCell.style.borderBottom = '1px solid #ddd';
                truckRow.appendChild(returnCell);
                
                truckDetailsTable.appendChild(truckRow);
            }
            
            truckDetailsElement.appendChild(truckDetailsTable);
            
            // Mettre à jour le job actuel avec les données de dispatch calculées
            const jobName = document.getElementById('jobName').textContent;
            const currentJob = jobs.find(job => `${job.name} (${job.company})` === jobName);
            
            if (currentJob) {
                // Créer un tableau de dispatch pour ce chantier
                const truckDetails = [];
                for (let i = 0; i < truckCount; i++) {
                    const truckLoadingMinutes = loadingTimeMinutes + (i * truckInterval);
                    const truckArrivalMinutes = truckLoadingMinutes + loadingTime + travelTime;
                    const truckDepartureMinutes = truckArrivalMinutes + unloadingTime;
                    const truckReturnMinutes = truckDepartureMinutes + travelTime;
                    
                    // Calculer l'heure d'arrivée du chauffeur (15 minutes avant le chargement)
                    const driverArrivalMinutes = truckLoadingMinutes - 15;
                    
                    const truckVolume = i === truckCount - 1 
                        ? cementQuantity - (truckCount - 1) * truckCapacity 
                        : truckCapacity;
                    
                    truckDetails.push({
                        truckNumber: i + 1,
                        jobId: currentJob.id,
                        jobName: currentJob.name,
                        company: currentJob.company,
                        volume: truckVolume,
                        driverArrivalMinutes: driverArrivalMinutes,
                        loadingTimeMinutes: truckLoadingMinutes,
                        arrivalTimeMinutes: truckArrivalMinutes,
                        departureTimeMinutes: truckDepartureMinutes,
                        returnTimeMinutes: truckReturnMinutes,
                        driverArrivalTime: minutesToTimeString(driverArrivalMinutes),
                        loadingTime: minutesToTimeString(truckLoadingMinutes),
                        arrivalTime: minutesToTimeString(truckArrivalMinutes),
                        departureTime: minutesToTimeString(truckDepartureMinutes),
                        returnTime: minutesToTimeString(truckReturnMinutes),
                        travelTime: travelTime,
                        loadingDuration: loadingTime,
                        unloadingDuration: unloadingTime
                    });
                }
                
                // Mettre à jour le chantier avec les données calculées
                currentJob.dispatch = truckDetails;
                currentJob.calculatedData = {
                    truckCapacity,
                    loadingTime,
                    unloadingTime,
                    truckInterval,
                    totalTrucks: truckCount
                };
                
                // Afficher un message de succès
                showStatusMessage(`Dispatch calculé avec succès pour ${currentJob.name}.`);
                
                // Sauvegarder les modifications
                saveJobs();
            }
        }
